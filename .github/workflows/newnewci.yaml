name: "no bling-bling tests"
on:
  pull_request:
    paths-ignore:
  push:
    #    branches:
    # - develop
jobs:
  nix-shell:
    name: check and see if it works
    runs-on: self-hosted
    timeout-minutes: 30
    container:
      image: docker.io/mayadata/ms-buildenv:gila
      options: --privileged -v /dev:/dev -v /:/host -v /lib/modules:/lib/modules
    steps:
      - uses: actions/checkout@v2
      - run: 'printf "#!/usr/bin/env bash\nchroot /host /usr/bin/env -i PATH=\"/sbin:/bin:/usr/bin\" iscsiadm \"\$@\"\n" > /bin/mayastor-iscsiadm && chmod +x /bin/mayastor-iscsiadm'
      - run: ln -s /host/bin/kmod /bin/modprobe
      - run: /bin/modprobe nbd
      - run: /bin/modprobe xfs
      - run: /bin/modprobe nvme_tcp
      - run: echo 8192 | tee /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
      - run: rm mayastor/.cargo/config
      - run: rm nvmeadm/.cargo/config
      - run: nix-shell --run "echo 'Pulling in the environment...'"
      - run: nix-shell --run "./scripts/test.sh"
  Build_and_test_moac:
    name: Build and run moac tests
    runs-on: ubuntu-latest
    container:
      image: docker.io/mayadata/ms-buildenv:latest
    steps:
      - uses: actions/checkout@v2
      # npm prepare is normally done by npm install but not if run as a root
      - run: cd csi/moac && npm install && npm run prepare && npm run compile
      - run: cd csi/moac && npm test
